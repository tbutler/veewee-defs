# Kickstart file automatically generated by anaconda.
install
#TB# nfs --server=qa-gse01 --dir=/kickstart/redhat5.5
cdrom
key --skip
lang en_GB.utf8
keyboard uk
skipx
#TB# - Network Configuration Mods
#TB#network --device eth0 --bootproto static --ip 10.1.244.179 --netmask 255.255.0.0 --gateway 10.1.1.80 --nameserver 10.1.253.45,10.1.253.46 --hostname qa-ci-sgn1
network --device eth0 --bootproto dhcp
rootpw --iscrypted $1$R1tSGOsU$Om/mX20rmv3jNOlrNFSWG/
firewall --enabled --port=22:tcp
authconfig --enableshadow --enablemd5
selinux --disabled
timezone Europe/London
services --disabled isdn,netfs,nfslock,pcmcia,ip6tables,kudzu,autofs,cups,firstboot,ip6tables,mcstrans,restorecond,yum-updatesd,rhnsd,atd,xfs,pcscd,bnx2id,bluetooth,hidd --enabled ntpd,nfs,snmpd,multipathd
bootloader --location=mbr --driveorder=hda --append="rhgb quiet elevator=deadline"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
clearpart --all --initlabel
part /boot --fstype ext3 --size=128
#TB#part pv.3 --size=100 --grow
part pv.3 --size=100 --grow
volgroup vg00 --pesize=32768 pv.3
logvol /  --fstype ext3 --name=volroot --vgname=vg00 --size=2048
logvol /var --fstype ext3 --name=volvar --vgname=vg00 --size=2000
logvol /usr --fstype ext3 --name=volusr --vgname=vg00 --size=4000
logvol /home  --fstype ext3 --name=volhome --vgname=vg00 --size=4096
logvol /tmp  --fstype ext3 --name=voltmp --vgname=vg00 --size=1024
logvol /opt  --fstype ext3 --name=volopt --vgname=vg00 --size=4000
logvol swap  --fstype swap --name=volswap --vgname=vg00 --size=2048
#TB - Patch
reboot

%packages
@core
@base
@ftp-server
@legacy-software-support
@mail-server
@admin-tools
@base-x
@gnome-desktop
kexec-tools
device-mapper-multipath
libsane-hpaio
glib
lm_sensors
rpm-build
rpm-devel
kernel-devel
gtk+
net-snmp
glibc-devel
gcc
sysstat
strace
# TB - Puppet dependencies
ruby-libs
ruby
libselinux-ruby
-sysreport
-dovecot

%post --interpreter /bin/ksh
#start services required to NFS mount from alpha
/sbin/service network start
/sbin/service portmap start
echo "domain yellgroup.com" >> /etc/resolv.conf
#TB#/bin/mount 10.1.2.64:/dsl/build/linux /mnt
/bin/mount 10.1.244.69:/mnt /mnt
if [ "$?" -ne 0 ]
then
echo "Not correctly mounted. Now exiting"
exit
fi
/bin/cp /mnt/issue_net /etc/issue.net
/mnt/create_linux_users
/bin/mkdir /home/asg/.ssh
/bin/chmod 600 /home/asg/.ssh
/bin/cp /mnt/asg-authorized_keys /home/asg/.ssh/authorized_keys
/bin/chown -R asg:asg /home/asg/.ssh
#set up yputils
/mnt/yputils_dir_ks
#sendmail set up
/bin/sed "s/dnl define(\`SMART_HOST', \`smtp.your.provider/define(\`SMART_HOST', \`mailhost/" /etc/mail/sendmail.mc > /tmp/sendmail.mc
/bin/mv /tmp/sendmail.mc /etc/mail/sendmail.mc
/usr/bin/m4 /etc/mail/sendmail.mc >/etc/mail/sendmail.cf
echo "root:     ussg-root@yellgroup.com" >> /etc/aliases
echo "LC_ALL=\"en_GB.utf8\"" >> /etc/sysconfig/i18n
#ssh set up
echo -e "session\trequired\tpam_limits.so" >> /etc/pam.d/su
echo -e "session\trequired\tpam_limits.so" >> /etc/pam.d/sshd
/bin/cp /mnt/sshd_config-linux /etc/ssh/sshd_config
/bin/cp /mnt/ssh_config-RH5 /etc/ssh/ssh_config
/bin/mkdir /root/.ssh
/bin/chmod 700 /root/.ssh
/bin/cp /mnt/authorized_keys /root/.ssh/
/usr/bin/ssh-keygen -t rsa -b 1024 -f /etc/ssh/ssh_host_rsa_key N ""
y=$( echo `hostname` | awk -F . '{print $1}')
typeset -u HN_UC=${y}
typeset -i HN_LEN=${#y}
HOSTNAME_STR="${HN_UC} computer."
PAD_NUM=`expr 25 - ${HN_LEN}`
cat >> ${ROOTDIR}/etc/motd << EOF
     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|
     |                           YELL Ltd                                 |
     |                                                                    |
     |  WARNING:  You  have  accessed  the YELL $(printf "%s %-${PAD_NUM}s|\n" ${HOSTNAME_STR})
     |  You are required to have a personal authorisation from the        |
     |  system administrator before you use this computer and you are     |
     |  strictly limited to the use set out in that written authorisation.|
     |  Unauthorised access or use of this system is prohibited and       |
     |  constitutes an offence under the Computer Misuse Act 1990.        |
     |  Unauthorised access to information is defined within Yell         |
     |  Security Policy Section 4 - Information Security.                 |
     |                                                                    |
     |  If you disclose customer or YELL information without authority    |
     |  you may be sacked and prosecuted.                                 |
     |                                                                    |
     |  If you are not authorised to use this system, terminate this      |
     |  session now.                                                      |
     |____________________________________________________________________|

EOF
/bin/cp /mnt/.bash_profile /root
/bin/cp /mnt/.readme /
/bin/cp /mnt/cron_root /var/spool/cron/root
/bin/mkdir /etc/multipath
/bin/sed "s/$y localhost/localhost/" /etc/hosts > /tmp/hosts
/bin/mv /tmp/hosts /etc/hosts
ipaddr=$(ifconfig eth0 | grep "inet addr" | awk '{print $2}' | awk -F : '{print $2}')
echo -e "$ipaddr\t$y\t`hostname`.yellgroup.com" >> /etc/hosts
cat /mnt/etc_hosts >> /etc/hosts
cat /mnt/modprobe_san >> /etc/modprobe.conf
/bin/cp /mnt/multipath.conf /etc/multipath.conf
modprobe dm_multipath
/bin/cp /mnt/etc_ntp /etc/ntp.conf
/bin/cp /mnt/yellgroup_resolv.conf /etc/resolv.conf
/bin/cp /mnt/rhosts /root/.rhosts
/bin/cp /mnt/yell_iptables_rhel5 /etc/sysconfig/iptables
/bin/cp /mnt/sysconfig_nfs /etc/sysconfig/nfs
/bin/cp /mnt/xpinfo /usr/local/bin/xpinfo
/bin/cp /mnt/SIM_INSTALL/snmpd.conf /etc/snmp/snmpd.conf
service messagebus restart
service haldaemon restart
chown patrol:patrol /opt/patrol
/usr/sbin/rhnreg_ks --profilename $y --username yell-ltd --password yell0w --force --proxy alpha:8080 --proxyUser rhnupdate --proxyPassword w11yCF!
echo "/sbin/modprobe ip_conntrack_ftp" >> /etc/rc.local
/bin/sed "s/postrotate/postrotate \n \t chmod g+r,o+r \/var\/log\/messages/" /etc/logrotate.d/syslog > /tmp/logrotate
/bin/mv /tmp/logrotate /etc/logrotate.d/syslog
/bin/cp /mnt/xClient-1.4.03-1.x86_64.rpm /root
/bin/cd /root
/bin/rpm -ivh xClient-1.4.03-1.x86_64.rpm
/bin/rm xClient-1.4.03-1.x86_64.rpm


# Change crontab so snow runs at 07.30 rather then 10.00
/usr/bin/crontab -l > crontab.BU
/usr/bin/crontab -l |/bin/grep -v "/usr/bin/xClient"> crontabRH.txt
echo "30 07 * * *       nice -n 10 "/usr/bin/xClient" 01010011011011100110111101110111 > /dev/null 2>&1" >> crontabRH.txt
/usr/bin/crontab crontabRH.txt
rm crontabRH.txt

# Change snow configs so matches crontabs and  snow runs at 07.30 rather then 10.00
/bin/cp /etc/snowclient.conf /etc/snowclient.conf_BAK
/bin/ sed "s/00 10.*/30 07 * * *$1/g" /etc/snowclient.conf  > /etc/snowclient.tmp
/bin/mv /etc/snowclient.tmp  /etc/snowclient.conf

yum -y -q update

%post
/usr/sbin/groupadd vagrant
/usr/sbin/useradd vagrant -g vagrant -G wheel
echo "vagrant"|passwd --stdin vagrant
echo "vagrant        ALL=(ALL)       NOPASSWD: ALL" >> /etc/sudoers
